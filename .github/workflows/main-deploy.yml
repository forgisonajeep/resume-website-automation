name: deploy

# Trigger on pull request (same as your PR deploy flow)
on:
  pull_request:
    types: [opened, synchronize, reopened]
  push: 
    branches:
      - main
  workflow_dispatch: {}
    

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1

    steps:
      - name: "Checkout repo"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: '1.5.7'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Read Terraform outputs (bucket name & website endpoint)
        run: |
          echo "=== Terraform init & output (prod deploy) ==="
          cd terraform

          terraform init -input=false

          # Extract clean outputs
          terraform output -raw bucket_name | tr -d '\r' > ../bucket.txt
          echo "DeploymentTrackingTable" > ../ddb_tracking.txt
          terraform output -raw website_endpoint | tr -d '\r' > ../website_endpoint.txt

          cd -

      - name: "Debug: show working dir & files"
        run: |
          echo "---- workspace root ----"
          pwd
          ls -la

          echo "---- terraform dir ----"
          ls -la terraform || true

          echo "---- head of generated files ----"
          if [ -f bucket.txt ]; then
            echo "bucket.txt exists:"
            sed -n '1,5p' bucket.txt
          else
            echo "bucket.txt missing"
          fi

          if [ -f ddb_tracking.txt ]; then
            echo "ddb_tracking.txt exists:"
            sed -n '1,5p' ddb_tracking.txt
          else
            echo "ddb_tracking.txt missing"
          fi

          if [ -f website_endpoint.txt ]; then
            echo "website_endpoint.txt exists:"
            sed -n '1,5p' website_endpoint.txt
          else
            echo "website_endpoint.txt missing"
          fi

      - name: "Setup Python"
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: "Install Python dependencies"
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: "Build resume HTML (local)"
        run: |
          if [ -f src/build_resume_site.py ]; then
            python src/build_resume_site.py
          else
            echo "build script missing, skipping"
          fi

      - name: "Promote beta build to prod (S3)"
        run: |
          if [ ! -f bucket.txt ]; then
            echo "bucket.txt missing - cannot promote to prod"
            exit 1
          fi

          BUCKET_NAME=$(cat bucket.txt)
          echo "Using bucket: ${BUCKET_NAME}"

          echo "Checking for beta/index.html..."
          aws s3 ls "s3://${BUCKET_NAME}/beta/index.html"

          echo "Copying beta/index.html -> prod/index.html..."
          aws s3 cp \
            "s3://${BUCKET_NAME}/beta/index.html" \
            "s3://${BUCKET_NAME}/prod/index.html" \
            --metadata-directive REPLACE \
            --content-type text/html

          echo "Copying prod/index.html -> root index.html (for website endpoint)..."
          aws s3 cp \
            "s3://${BUCKET_NAME}/prod/index.html" \
            "s3://${BUCKET_NAME}/index.html" \
            --metadata-directive REPLACE \
            --content-type text/html

      - name: "Write deployment event to DynamoDB"
        run: |
          if [ -f ddb_tracking.txt ]; then
            echo "Running deployment event writer"
            python scripts/write_deployment_event.py \
              --table-file ddb_tracking.txt \
              --bucket-file bucket.txt \
              --environment prod \
              --region "${AWS_REGION}" || true
          else
            echo "Skipping DDB event write - ddb_tracking.txt not found"
          fi

      - name: "Output S3 website endpoint (for screenshots)"
        run: |
          if [ -f website_endpoint.txt ]; then
            echo "Website URL: $(cat website_endpoint.txt)"
          else
            echo "website_endpoint.txt missing"
          fi

      - name: "Cleanup temp files"
        run: |
          rm -f bucket.txt ddb_tracking.txt website_endpoint.txt || true

      - name: "Complete job"
        run: |
          echo "Deploy job finished"
