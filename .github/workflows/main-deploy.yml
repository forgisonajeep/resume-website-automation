name: deploy

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read terraform outputs (bucket name & website endpoint)
        run: |
          echo "=== Terraform init & output ==="
          terraform -chdir=terraform init -input=false
          terraform -chdir=terraform plan -input=false || true
          terraform -chdir=terraform output -raw bucket_name > bucket.txt || true
          terraform -chdir=terraform output -raw deployment_tracking_table > ddb_tracking.txt || true
          terraform -chdir=terraform output -raw website_endpoint > website_endpoint.txt || true

      - name: Debug: show working dir & files
        run: |
          echo "---- workspace root ----"
          pwd
          ls -la

          echo "---- terraform dir ----"
          ls -la terraform || true

          echo "---- head of generated files ----"
          if [ -f bucket.txt ]; then
            echo "bucket.txt exists:"
            sed -n '1,5p' bucket.txt
          else
            echo "bucket.txt not found"
          fi

          if [ -f ddb_tracking.txt ]; then
            echo "ddb_tracking.txt exists:"
            sed -n '1,5p' ddb_tracking.txt
          else
            echo "ddb_tracking.txt not found"
          fi

          if [ -f website_endpoint.txt ]; then
            echo "website_endpoint.txt exists:"
            sed -n '1,5p' website_endpoint.txt
          else
            echo "website_endpoint.txt not found"
          fi

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "No requirements.txt found, skipping install"
          fi

      - name: Build resume HTML (local)
        run: |
          if [ -f src/build_resume_site.py ]; then
            python src/build_resume_site.py
          else
            echo "src/build_resume_site.py not found, skipping build"
          fi

      - name: Write deployment event to DynamoDB
        run: |
          PY=python3
          if ! command -v $PY >/dev/null 2>&1; then
            PY=python
          fi

          if [ ! -f ddb_tracking.txt ]; then
            echo "ERROR: ddb_tracking.txt not present, aborting write step"
            exit 1
          fi

          if [ ! -f bucket.txt ]; then
            echo "ERROR: bucket.txt not present, aborting write step"
            exit 1
          fi

          $PY scripts/write_deployment_event.py \
            --table-file ddb_tracking.txt \
            --bucket-file bucket.txt \
            --environment prod \
            --region us-east-1

      - name: Output S3 website endpoint (for screenshots)
        run: |
          if [ -f website_endpoint.txt ]; then
            echo "Website URL: $(cat website_endpoint.txt)"
          else
            echo "website_endpoint.txt missing"
          fi

      - name: Cleanup temp files
        run: |
          rm -f bucket.txt ddb_tracking.txt website_endpoint.txt || true

      - name: Complete job
        run: |
          echo "Deploy job finished."
