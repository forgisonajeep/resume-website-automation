name: deploy

# Trigger on pull request (same as your PR deploy flow)
on:
  pull_request:
    types: [opened, synchronize, reopened]
  push: 
    branches:
      - main
  workflow_dispatch: {}
    

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1

    steps:
      - name: "Checkout repo"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: '1.5.7'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: "Read terraform outputs (bucket name & website endpoint)"
        run: |
          echo "=== Terraform init & output ==="
          # run terraform commands from inside the terraform directory to avoid
          # global-flag / wrapper issues on the runner
          cd terraform
          terraform init -input=false
          terraform plan -input=false || true

          # collect outputs to files (ignore errors so job continues)
          terraform output -raw bucket_name > ../bucket.txt || true

          # HARD-CODE the DynamoDB table name
          echo "DeploymentTrackingTable" > ../ddb_tracking.txt

          terraform output -raw website_endpoint > ../website_endpoint.txt || true

          # return to repo root
          cd -

      - name: "Debug: show working dir & files"
        run: |
          echo "---- workspace root ----"
          pwd
          ls -la

          echo "---- terraform dir ----"
          ls -la terraform || true

          echo "---- head of generated files ----"
          if [ -f bucket.txt ]; then
            echo "bucket.txt exists:"
            sed -n '1,5p' bucket.txt
          else
            echo "bucket.txt missing"
          fi

          if [ -f ddb_tracking.txt ]; then
            echo "ddb_tracking.txt exists:"
            sed -n '1,5p' ddb_tracking.txt
          else
            echo "ddb_tracking.txt missing"
          fi

          if [ -f website_endpoint.txt ]; then
            echo "website_endpoint.txt exists:"
            sed -n '1,5p' website_endpoint.txt
          else
            echo "website_endpoint.txt missing"
          fi

      - name: "Setup Python"
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: "Install Python dependencies"
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: "Build resume HTML (local)"
        run: |
          if [ -f src/build_resume_site.py ]; then
            python src/build_resume_site.py
          else
            echo "build script missing, skipping"
          fi

      - name: "Upload site to S3 (beta)"
        run: |
          # placeholder: actual S3 upload commands go here
          echo "Uploading site to S3 (beta) - placeholder"

      - name: "Write deployment event to DynamoDB"
        run: |
          if [ -f ddb_tracking.txt ]; then
            echo "Running deployment event writer"
            python scripts/write_deployment_event.py \
              --table-file ddb_tracking.txt \
              --bucket-file bucket.txt \
              --environment prod \
              --region "${AWS_REGION}" || true
          else
            echo "Skipping DDB event write - ddb_tracking.txt not found"
          fi

      - name: "Output S3 website endpoint (for screenshots)"
        run: |
          if [ -f website_endpoint.txt ]; then
            echo "Website URL: $(cat website_endpoint.txt)"
          else
            echo "website_endpoint.txt missing"
          fi

      - name: "Cleanup temp files"
        run: |
          rm -f bucket.txt ddb_tracking.txt website_endpoint.txt || true

      - name: "Complete job"
        run: |
          echo "Deploy job finished"
